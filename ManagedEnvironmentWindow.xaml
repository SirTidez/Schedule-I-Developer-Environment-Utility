<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="Schedule_I_Developer_Environment_Utility.ManagedEnvironmentWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    mc:Ignorable="d">
    <Grid Padding="24">
        <StackPanel Spacing="8">
            <TextBlock Text="Managed Environment" FontSize="20" FontWeight="SemiBold" />

            <!-- Menu bar -->
            <muxc:MenuBar>
                <muxc:MenuBarItem Title="File">
                    <MenuFlyoutItem Text="Refresh" Click="OnMenuRefresh" />
                    <MenuFlyoutItem Text="Open Managed Environment" Click="OnMenuOpenManagedFolder" />
                    <MenuFlyoutItem Text="Open Config Folder" Click="OnMenuOpenConfigFolder" />
                    <MenuFlyoutSeparator />
                    <MenuFlyoutItem Text="Exit" Click="OnCloseClick" />
                </muxc:MenuBarItem>
                <muxc:MenuBarItem Title="Edit">
                    <MenuFlyoutItem Text="Copy Managed Path" Click="OnMenuCopyManagedPath" />
                </muxc:MenuBarItem>
                <muxc:MenuBarItem Title="Tools">
                    <MenuFlyoutItem Text="Revalidate Branches" Click="OnMenuRefresh" />
                </muxc:MenuBarItem>
                <muxc:MenuBarItem Title="Help">
                    <MenuFlyoutItem Text="About" Click="OnMenuAbout" />
                </muxc:MenuBarItem>
            </muxc:MenuBar>

            <!-- Legend -->
            <StackPanel Orientation="Horizontal" Spacing="16" Margin="0,6,0,0">
                <StackPanel Orientation="Horizontal" Spacing="6">
                    <TextBlock Text="&#xE73E;" FontFamily="Segoe MDL2 Assets" Foreground="LimeGreen"/>
                    <TextBlock Text="Current (stored = live)"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="6">
                    <TextBlock Text="&#xE895;" FontFamily="Segoe MDL2 Assets" Foreground="DodgerBlue"/>
                    <TextBlock Text="Update available (stored &lt; live)"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="6">
                    <TextBlock Text="&#xE711;" FontFamily="Segoe MDL2 Assets" Foreground="Red"/>
                    <TextBlock Text="Error in local install"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="6">
                    <Border Width="10" Height="14" Background="#FF2B6CB0" />
                    <TextBlock Text="Currently loaded in Steam"/>
                </StackPanel>
            </StackPanel>

            <!-- Table header -->
            <Grid ColumnDefinitions="40,220,140,140,100,120,100,*" Padding="0,0,0,0" HorizontalAlignment="Stretch">
                <TextBlock Text="" />
                <TextBlock Text="Branch" FontWeight="SemiBold" Grid.Column="1" VerticalAlignment="Center" />
                <TextBlock Text="Status" FontWeight="SemiBold" Grid.Column="2" VerticalAlignment="Center" />
                <TextBlock Text="Stored Build" FontWeight="SemiBold" Grid.Column="3" VerticalAlignment="Center" />
                <TextBlock Text="Mods" FontWeight="SemiBold" Grid.Column="4" VerticalAlignment="Center" />
                <TextBlock Text="Size" FontWeight="SemiBold" Grid.Column="5" VerticalAlignment="Center" />
                <TextBlock Text="Files" FontWeight="SemiBold" Grid.Column="6" VerticalAlignment="Center" />
                <TextBlock Text="Actions" FontWeight="SemiBold" Grid.Column="7" VerticalAlignment="Center" />
            </Grid>

            <ListView ItemsSource="{Binding Branches}" Height="360" HorizontalAlignment="Stretch">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="Padding" Value="0" />
                        <Setter Property="Margin" Value="0" />
                    </Style>
                </ListView.ItemContainerStyle>
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <Grid>
                            <!-- Subtle left accent for current Steam branch -->
                            <Border Width="4" HorizontalAlignment="Left" Background="#FF2B6CB0" Visibility="{Binding RowHighlightVisibility}" />
                        <Grid ColumnDefinitions="40,220,140,140,100,120,100,*" VerticalAlignment="Center" Padding="0,0,0,0">
                                <TextBlock Text="{Binding StatusGlyph}" Grid.Column="0" FontFamily="Segoe MDL2 Assets" HorizontalAlignment="Center" Foreground="{Binding StatusBrush}">
                                    <ToolTipService.ToolTip>
                                        <StackPanel>
                                            <TextBlock Text="{Binding StatusDisplay}" FontWeight="SemiBold" />
                                            <TextBlock Text="{Binding StatusDescription}" />
                                        </StackPanel>
                                    </ToolTipService.ToolTip>
                                </TextBlock>
                                <TextBlock Text="{Binding DisplayName}" Grid.Column="1" VerticalAlignment="Center">
                                    <ToolTipService.ToolTip>
                                        <TextBlock Text="{Binding FolderPath}"/>
                                    </ToolTipService.ToolTip>
                                </TextBlock>
                            <TextBlock Text="{Binding StatusDisplay}" Grid.Column="2" VerticalAlignment="Center" />
                                <TextBlock Text="{Binding LocalBuildId}" Grid.Column="3" VerticalAlignment="Center" />
                                <TextBlock Text="{Binding ModsDllCount}" Grid.Column="4" VerticalAlignment="Center">
                                    <TextBlock.ContextFlyout>
                                        <MenuFlyout>
                                            <MenuFlyoutItem Text="Open Mods Folder" Click="OnOpenModsFolder" Tag="{Binding ModsFolderPath}" />
                                            <MenuFlyoutItem Text="Back Up Mods..." Click="OnBackupModsFolder" Tag="{Binding ModsFolderPath}" />
                                            <MenuFlyoutItem Text="Clear Mods" Click="OnClearModsFolder" Tag="{Binding ModsFolderPath}" />
                                            <MenuFlyoutSeparator />
                                            <MenuFlyoutItem Text="Install Default Mods" Click="OnInstallDefaultMods" IsEnabled="{Binding CanInstallDefaultMods}" />
                                        </MenuFlyout>
                                    </TextBlock.ContextFlyout>
                                </TextBlock>
                                <TextBlock Text="{Binding FormattedSize}" Grid.Column="5" VerticalAlignment="Center" />
                                <TextBlock Text="{Binding FormattedFileCount}" Grid.Column="6" VerticalAlignment="Center" />
                            <StackPanel Orientation="Horizontal" Grid.Column="7" Spacing="8" VerticalAlignment="Center">
                                <Button Click="OnOpenBranchExe" Tag="{Binding ExecutablePath}" Width="100" Height="36" IsEnabled="{Binding IsInstalled}" Opacity="{Binding PlayOpacity}" HorizontalContentAlignment="Center" VerticalContentAlignment="Center">
                                    <FontIcon Glyph="&#xE768;" />
                                    <ToolTipService.ToolTip>
                                        <TextBlock Text="{Binding PlayTooltip}" />
                                    </ToolTipService.ToolTip>
                                </Button>
                                <Button Click="OnOpenBranchFolder" Tag="{Binding FolderPath}" Visibility="{Binding InstalledVisibility}" Width="100" Height="36" HorizontalContentAlignment="Center" VerticalContentAlignment="Center">
                                    <FontIcon Glyph="&#xE8B7;" />
                                    <ToolTipService.ToolTip>
                                        <TextBlock Text="Open folder" />
                                    </ToolTipService.ToolTip>
                                </Button>
                                <Button Click="OnInstallBranch" Tag="{Binding BranchName}" Visibility="{Binding InstallVisibility}" Width="100" Height="36" Content="Install" HorizontalContentAlignment="Center" VerticalContentAlignment="Center" />
                            </StackPanel>
                            </Grid>
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>

            <StackPanel Orientation="Horizontal" Spacing="8">
                <Button Content="Refresh" Click="OnRefreshClick" Width="96"/>
                <Button Content="Close" Click="OnCloseClick" Width="96"/>
            </StackPanel>
        </StackPanel>
    </Grid>
</Window>
